<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="../node_modules/v-toaster/dist/v-toaster.css">
  <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

  <!-- Compiled and minified JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <title></title>
</head>

<body>
  <div id="test"></div>
</body>

<style>
  body {
    font-family: sans-serif;
  }
  .container {
    background-color: white;
    max-width: 1200px;
    padding: 20px;
    margin-top: 20px;
  }
  .field {
    width: 130px!important;
  }
  h1 {
    text-align: center;

  }
</style>

<script>
  const Lecteur = require('./lecteur.js')
  const Http = new XMLHttpRequest();

  import Vue from 'vue';
  import Toaster from 'v-toaster'
  Vue.use(Toaster, { timeout: 2000 })
  import Main from './main';

  // Initialisation du framework Vue
  const app = new Vue(Main).$mount('#test');
  // Initialisation du lecteur USB
  const lecteur = new Lecteur("COMtest")
  // Fake reception every 2s
  lecteur.mockReception()

  // Lorsqu'une carte est lue
  lecteur.on('cardRead', (x) => {
    app.cardRead()
    // On envoie une requete de récupération des données sur l'API
    const url = 'http://noxunote.fr:3000/getClient/' + x;
    Http.open("GET", url);
    Http.send();
    // Quand la réponse de l'API est reçue
    Http.onreadystatechange = (e) => {
      if (Http.readyState === 4 && Http.status === 200) {
        const res = Http.responseText
        // Si la réponse est présente
        if (res.length > 0) {
          // On crée un objet réponse
          const resObj = JSON.parse(res)
          resObj.defined = true
          console.log("Réponse de l'API reçue pour client : " + x)
          console.log(resObj)
          app.receivedData()
          app.donneesClient = resObj
        }
      }
    }
  })

  app.donneesClient = {
    defined: false
  }

</script>

</html>